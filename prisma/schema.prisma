datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id                        String          @id @default(uuid())
  credits                   Int             @default(0)
  apiKeys                   APIKey[]
  apiUsage                  APIUsage[]
  deposits                  Deposit[]
}

model APIKey {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())
  lastUsedAt                DateTime?
  name                      String
  key                       String          @unique
  isActive                  Boolean         @default(true)

  user                      User            @relation(fields: [userId], references: [id])
  userId                    String
  usage                     APIUsage[]
}

enum Quality {
  auto
  low
  medium
  high
}

// Input types enum for tracking what types of input were used in the request
enum InputType {
  PROMPT      // Text prompt
  IMAGE       // Image input (for image-to-image, inpainting, etc.)
  VIDEO       // Video input (for video-to-video, etc.)
  AUDIO       // Audio input (for future audio models)
}

model APIUsage {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())
  model                     String
  provider                  String
  prompt                    String
  cost                      Int
  speedMs                   Int
  imageSize                 String
  quality                   Quality?
  seconds                   Decimal?        @db.Decimal(8, 2)
  inputTypes                InputType[]     @default([])
  status                    String
  error                     String?
  metadata                  Json?
  apiKeyTempJwt             Boolean         @default(false)
  ip                        String?
  outputUrls                String[]        @default([])
  originalResponseFromProvider Json?

  apiKey                    APIKey?          @relation(fields: [apiKeyId], references: [id])
  apiKeyId                  String?
  user                      User            @relation(fields: [userId], references: [id])
  userId                    String
}

// Payment provider enum
enum PaymentProvider {
  STRIPE
  LEMONSQUEEZY
  COINBASE_COMMERCE
  ADMIN_MANUAL
}

// Deposit status enum
enum DepositStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

model Deposit {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())
  updatedAt                 DateTime        @updatedAt

  user                      User            @relation(fields: [userId], references: [id])
  userId                    String

  provider                  PaymentProvider
  providerEventId           String
  providerPaymentId         String
  
  amount                    Float
  currency                  String
  creditsAdded              Int
  
  status                    DepositStatus   @default(PENDING)
  processedAt               DateTime?
  failureReason             String?
  
  metadata                  Json?
  webhookPayload            Json?

  @@unique([provider, providerEventId])
}